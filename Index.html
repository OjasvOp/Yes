<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NalloKeMemes Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-100">
    <div id="login-container" class="container mx-auto mt-10 p-4">
        <h1 class="text-3xl font-bold mb-4">Welcome to NalloKeMemes Chat</h1>
        <input type="text" id="username" placeholder="Username" class="border p-2 mb-2 w-full">
        <input type="password" id="password" placeholder="Password" class="border p-2 mb-2 w-full">
        <p class="text-sm text-gray-600 mb-2">Write any random password so that you can access your profile from different devices.</p>
        <button id="login-btn" class="bg-blue-500 text-white p-2 rounded">Enter Chat</button>
    </div>

    <div id="chat-container" class="container mx-auto mt-10 p-4 hidden">
        <h1 class="text-3xl font-bold mb-4">NalloKeMemes Chat</h1>
        <div id="messages" class="chat-container bg-white p-4 rounded-lg shadow-md overflow-y-auto mb-4 h-96"></div>
        <div class="flex space-x-2">
            <input type="text" id="message-input" placeholder="Type your message..." class="border p-2 flex-grow">
            <button id="send-btn" class="bg-blue-500 text-white p-2 rounded">Send</button>
        </div>
    </div>

    <div id="dm-container" class="container mx-auto mt-10 p-4 hidden">
        <h2 id="dm-header" class="text-2xl font-bold mb-4"></h2>
        <div id="dm-messages" class="chat-container bg-white p-4 rounded-lg shadow-md overflow-y-auto mb-4 h-96"></div>
        <div class="flex space-x-2">
            <input type="text" id="dm-input" placeholder="Type your message..." class="border p-2 flex-grow">
            <button id="dm-send-btn" class="bg-blue-500 text-white p-2 rounded">Send</button>
        </div>
        <button id="back-to-chat-btn" class="mt-4 bg-gray-300 text-black p-2 rounded">Back to Main Chat</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9ZEXXr_jER8xQUfnBjfbfo54amQ3LsSU",
            authDomain: "real-7f191.firebaseapp.com",
            projectId: "real-7f191",
            storageBucket: "real-7f191.appspot.com",
            messagingSenderId: "364774424342",
            appId: "1:364774424342:web:9a5a7696db204523b29a37",
            measurementId: "G-KFDQ3KYW58"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM elements
        const loginContainer = document.getElementById('login-container');
        const chatContainer = document.getElementById('chat-container');
        const dmContainer = document.getElementById('dm-container');
        const messagesDiv = document.getElementById('messages');
        const dmMessagesDiv = document.getElementById('dm-messages');
        const messageInput = document.getElementById('message-input');
        const dmInput = document.getElementById('dm-input');
        const sendBtn = document.getElementById('send-btn');
        const dmSendBtn = document.getElementById('dm-send-btn');
        const loginBtn = document.getElementById('login-btn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const backToChatBtn = document.getElementById('back-to-chat-btn');
        const dmHeader = document.getElementById('dm-header');

        let currentUser = null;
        let currentDmUser = null;

        // Check if user is already logged in
        const savedUsername = localStorage.getItem('username');
        const savedPassword = localStorage.getItem('password');
        if (savedUsername && savedPassword) {
            login(savedUsername, savedPassword);
        }

        // Login function
        function login(username, password) {
            auth.signInWithEmailAndPassword(username + '@nallokememes.com', password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    localStorage.setItem('username', username);
                    localStorage.setItem('password', password);
                    loginContainer.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    loadMessages();
                })
                .catch((error) => {
                    // If user doesn't exist, create a new account
                    auth.createUserWithEmailAndPassword(username + '@nallokememes.com', password)
                        .then((userCredential) => {
                            currentUser = userCredential.user;
                            localStorage.setItem('username', username);
                            localStorage.setItem('password', password);
                            loginContainer.classList.add('hidden');
                            chatContainer.classList.remove('hidden');
                            loadMessages();
                        })
                        .catch((error) => {
                            console.error('Error creating user:', error);
                            alert('Error creating user. Please try again.');
                        });
                });
        }

        // Load messages from Firestore
        function loadMessages() {
            db.collection('messages').orderBy('timestamp').onSnapshot((snapshot) => {
                messagesDiv.innerHTML = '';
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const messageElement = createMessageElement(message, doc.id);
                    messagesDiv.appendChild(messageElement);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // Create message element
        function createMessageElement(message, messageId) {
            const div = document.createElement('div');
            div.className = 'mb-2 p-2 rounded';
            div.style.backgroundColor = message.sender === currentUser.email.split('@')[0] ? '#e6f3ff' : '#f0f0f0';

            const senderSpan = document.createElement('span');
            senderSpan.className = 'font-bold';
            senderSpan.textContent = message.sender + ': ';

            const contentSpan = document.createElement('span');
            contentSpan.textContent = message.content;

            div.appendChild(senderSpan);
            div.appendChild(contentSpan);

            if (message.replyTo) {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'text-sm text-gray-600 mt-1';
                replyDiv.textContent = `Replying to: ${message.replyTo.sender}: ${message.replyTo.content}`;
                div.appendChild(replyDiv);
            }

            div.addEventListener('click', () => showReplyOption(messageId, message));

            return div;
        }

        // Show reply option
        function showReplyOption(messageId, message) {
            const replyBtn = document.createElement('button');
            replyBtn.textContent = 'Reply';
            replyBtn.className = 'bg-gray-200 text-sm p-1 rounded mt-1';
            replyBtn.addEventListener('click', () => {
                messageInput.value = `Replying to ${message.sender}: `;
                messageInput.dataset.replyTo = JSON.stringify({
                    id: messageId,
                    sender: message.sender,
                    content: message.content
                });
                messageInput.focus();
            });

            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement && !messageElement.querySelector('button')) {
                messageElement.appendChild(replyBtn);
            }
        }

        // Send message
        function sendMessage() {
            const content = messageInput.value.trim();
            if (content) {
                const replyTo = messageInput.dataset.replyTo ? JSON.parse(messageInput.dataset.replyTo) : null;
                const message = {
                    sender: currentUser.email.split('@')[0],
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    replyTo: replyTo
                };

                db.collection('messages').add(message)
                    .then(() => {
                        messageInput.value = '';
                        messageInput.dataset.replyTo = '';
                    })
                    .catch((error) => {
                        console.error('Error sending message:', error);
                    });
            }
        }

        // Load direct messages
        function loadDirectMessages(otherUser) {
            const chatId = [currentUser.email.split('@')[0], otherUser].sort().join('_');
            db.collection('directMessages').doc(chatId).collection('messages').orderBy('timestamp').onSnapshot((snapshot) => {
                dmMessagesDiv.innerHTML = '';
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const messageElement = createMessageElement(message, doc.id);
                    dmMessagesDiv.appendChild(messageElement);
                });
                dmMessagesDiv.scrollTop = dmMessagesDiv.scrollHeight;
            });
        }

        // Send direct message
        function sendDirectMessage() {
            const content = dmInput.value.trim();
            if (content && currentDmUser) {
                const chatId = [currentUser.email.split('@')[0], currentDmUser].sort().join('_');
                const message = {
                    sender: currentUser.email.split('@')[0],
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                db.collection('directMessages').doc(chatId).collection('messages').add(message)
                    .then(() => {
                        dmInput.value = '';
                    })
                    .catch((error) => {
                        console.error('Error sending direct message:', error);
                    });
            }
        }

        // Event listeners
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            if (username && password) {
                login(username, password);
            }
        });

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        dmSendBtn.addEventListener('click', sendDirectMessage);
        dmInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendDirectMessage();
            }
        });

        backToChatBtn.addEventListener('click', () => {
            dmContainer.classList.add('hidden');
            chatContainer.classList.remove('hidden');
            currentDmUser = null;
        });

        // Function to open DM window
        function openDmWindow(otherUser) {
            currentDmUser = otherUser;
            chatContainer.classList.add('hidden');
            dmContainer.classList.remove('hidden');
            dmHeader.textContent = `Direct Message with ${otherUser}`;
            loadDirectMessages(otherUser);
        }

        // Add click event listeners to usernames in the main chat
        messagesDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('font-bold')) {
                const otherUser = e.target.textContent.split(':')[0].trim();
                if (otherUser !== currentUser.email.split('@')[0]) {
                    openDmWindow(otherUser);
                }
            }
        });
    </script>
</body>
</html>
