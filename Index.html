<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NalloKeMemes Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        .full-page {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 100px; /* Increased padding to prevent overlap */
        }
        .reply-preview {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }
        .message-input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 10px;
            border-top: 1px solid #e5e7eb;
        }
        .message-input-spacer {
            height: 80px; /* Matches the height of the input container */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="login-container" class="full-page container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Welcome to NalloKeMemes Chat</h1>
        <input type="text" id="username" placeholder="Username" class="border p-2 mb-2 w-full">
        <input type="password" id="password" placeholder="Password" class="border p-2 mb-2 w-full">
        <p id="password-criteria" class="text-sm text-gray-600 mb-2">Password must be at least 6 characters long.</p>
        <button id="login-btn" class="bg-blue-500 text-white p-2 rounded">Enter Chat</button>
    </div>

    <div id="chat-container" class="full-page container mx-auto p-4 hidden">
        <h1 class="text-3xl font-bold mb-4">NalloKeMemes Chat</h1>
        <button id="open-dms-btn" class="bg-green-500 text-white p-2 rounded mb-4">Open DMs</button>
        <div id="messages" class="chat-container bg-white p-4 rounded-lg shadow-md mb-4"></div>
        <div id="reply-preview" class="reply-preview hidden"></div>
        <div class="message-input-spacer"></div>
        <div class="message-input-container">
            <div class="flex space-x-2">
                <input type="text" id="message-input" placeholder="Type your message..." class="border p-2 flex-grow">
                <button id="send-btn" class="bg-blue-500 text-white p-2 rounded">Send</button>
            </div>
        </div>
    </div>

    <div id="dm-container" class="full-page container mx-auto p-4 hidden">
        <h2 id="dm-header" class="text-2xl font-bold mb-4"></h2>
        <div id="dm-messages" class="chat-container bg-white p-4 rounded-lg shadow-md mb-4"></div>
        <div id="dm-reply-preview" class="reply-preview hidden"></div>
        <div class="message-input-spacer"></div>
        <div class="message-input-container">
            <div class="flex space-x-2">
                <input type="text" id="dm-input" placeholder="Type your message..." class="border p-2 flex-grow">
                <button id="dm-send-btn" class="bg-blue-500 text-white p-2 rounded">Send</button>
            </div>
        </div>
        <button id="back-to-chat-btn" class="mt-4 bg-gray-300 text-black p-2 rounded">Back to Main Chat</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC9ZEXXr_jER8xQUfnBjfbfo54amQ3LsSU",
            authDomain: "real-7f191.firebaseapp.com",
            projectId: "real-7f191",
            storageBucket: "real-7f191.appspot.com",
            messagingSenderId: "364774424342",
            appId: "1:364774424342:web:9a5a7696db204523b29a37",
            measurementId: "G-KFDQ3KYW58"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM elements
        const loginContainer = document.getElementById('login-container');
        const chatContainer = document.getElementById('chat-container');
        const dmContainer = document.getElementById('dm-container');
        const messagesDiv = document.getElementById('messages');
        const dmMessagesDiv = document.getElementById('dm-messages');
        const messageInput = document.getElementById('message-input');
        const dmInput = document.getElementById('dm-input');
        const sendBtn = document.getElementById('send-btn');
        const dmSendBtn = document.getElementById('dm-send-btn');
        const loginBtn = document.getElementById('login-btn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const backToChatBtn = document.getElementById('back-to-chat-btn');
        const dmHeader = document.getElementById('dm-header');
        const passwordCriteria = document.getElementById('password-criteria');
        const openDmsBtn = document.getElementById('open-dms-btn');
        const replyPreview = document.getElementById('reply-preview');
        const dmReplyPreview = document.getElementById('dm-reply-preview');

        let currentUser = null;
        let currentDmUser = null;
        let replyingTo = null;
        let dmReplyingTo = null;

        // Check if user is already logged in
        const savedUsername = localStorage.getItem('username');
        const savedPassword = localStorage.getItem('password');
        if (savedUsername && savedPassword) {
            login(savedUsername, savedPassword);
        }

        // Login function
        function login(username, password) {
            if (password.length < 6) {
                passwordCriteria.textContent = "Password must be at least 6 characters long.";
                passwordCriteria.classList.add('text-red-500');
                return;
            }

            auth.signInWithEmailAndPassword(username + '@nallokememes.com', password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    localStorage.setItem('username', username);
                    localStorage.setItem('password', password);
                    loginContainer.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    loadMessages();
                })
                .catch((error) => {
                    // If user doesn't exist, create a new account
                    auth.createUserWithEmailAndPassword(username + '@nallokememes.com', password)
                        .then((userCredential) => {
                            currentUser = userCredential.user;
                            localStorage.setItem('username', username);
                            localStorage.setItem('password', password);
                            loginContainer.classList.add('hidden');
                            chatContainer.classList.remove('hidden');
                            loadMessages();
                        })
                        .catch((error) => {
                            console.error('Error creating user:', error);
                            alert('Error creating user. Please try again.');
                        });
                });
        }

        // Load messages from Firestore
        function loadMessages() {
            db.collection('messages').orderBy('timestamp').onSnapshot((snapshot) => {
                messagesDiv.innerHTML = '';
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const messageElement = createMessageElement(message, doc.id);
                    messagesDiv.appendChild(messageElement);
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // Create message element
        function createMessageElement(message, messageId) {
            const div = document.createElement('div');
            div.className = 'mb-2 p-2 rounded';
            div.style.backgroundColor = message.sender === currentUser.email.split('@')[0] ? '#e6f3ff' : '#f0f0f0';
            div.dataset.messageId = messageId;

            if (message.replyTo) {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'text-sm text-gray-600 mb-1';
                replyDiv.textContent = `${message.replyTo.sender}: ${message.replyTo.content}`;
                div.appendChild(replyDiv);
            }

            const messageContent = document.createElement('div');
            messageContent.className = 'flex justify-between items-start';

            const leftPart = document.createElement('div');
            leftPart.className = 'flex-grow';

            const senderSpan = document.createElement('span');
            senderSpan.className = 'font-bold cursor-pointer';
            senderSpan.textContent = message.sender + ': ';
            senderSpan.addEventListener('click', () => {
                if (message.sender !== currentUser.email.split('@')[0]) {
                    openDmWindow(message.sender);
                }
            });

            const contentSpan = document.createElement('span');
            contentSpan.textContent = message.content;

            leftPart.appendChild(senderSpan);
            leftPart.appendChild(contentSpan);

            const rightPart = document.createElement('div');
            rightPart.className = 'flex items-center';

            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs text-gray-500 mr-2';
            timeSpan.textContent = formatTimestamp(message.timestamp);

            const replyBtn = document.createElement('button');
            replyBtn.textContent = 'Reply';
            replyBtn.className = 'bg-gray-200 text-xs p-1 rounded mr-2';
            replyBtn.addEventListener('click', () => showReplyOption(messageId, message));

            rightPart.appendChild(timeSpan);
            rightPart.appendChild(replyBtn);

            if (message.sender === currentUser.email.split('@')[0]) {
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'bg-red-200 text-xs p-1 rounded';
                deleteBtn.addEventListener('click', () => deleteMessage(messageId));
                rightPart.appendChild(deleteBtn);
            }

            messageContent.appendChild(leftPart);
            messageContent.appendChild(rightPart);

            div.appendChild(messageContent);

            return div;
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return date.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
        }

        // Show reply option
        function showReplyOption(messageId, message) {
            replyingTo = { id: messageId, sender: message.sender, content: message.content };
            replyPreview.textContent = `Replying to ${message.sender}: ${message.content}`;
            replyPreview.classList.remove('hidden');
            messageInput.focus();
        }

        // Send message
        function sendMessage() {
            const content = messageInput.value.trim();
            if (content) {
                const message = {
                    sender: currentUser.email.split('@')[0],
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    replyTo: replyingTo
                };

                db.collection('messages').add(message)
                    .then(() => {
                        messageInput.value = '';
                        replyingTo = null;
                        replyPreview.textContent = '';
                        replyPreview.classList.add('hidden');
                    })
                    .catch((error) => {
                        console.error('Error sending message:', error);
                    });
            }
        }

        // Delete message
        function deleteMessage(messageId) {
            db.collection('messages').doc(messageId).delete()
                .then(() => {
                    console.log('Message deleted successfully');
                })
                .catch((error) => {
                    console.error('Error deleting message:', error);
                });
        }

        // Load direct messages
        function loadDirectMessages(otherUser) {
            const chatId = [currentUser.email.split('@')[0], otherUser].sort().join('_');
            db.collection('directMessages').doc(chatId).collection('messages').orderBy('timestamp').onSnapshot((snapshot) => {
                dmMessagesDiv.innerHTML = '';
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const messageElement = createDmMessageElement(message, doc.id);
                    dmMessagesDiv.appendChild(messageElement);
                });
                dmMessagesDiv.scrollTop = dmMessagesDiv.scrollHeight;
            });
        }

        // Create DM message element
        function createDmMessageElement(message, messageId) {
            const div = document.createElement('div');
            div.className = 'mb-2 p-2 rounded';
            div.style.backgroundColor = message.sender === currentUser.email.split('@')[0] ? '#e6f3ff' : '#f0f0f0';

            if (message.replyTo) {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'text-sm text-gray-600 mb-1';
                replyDiv.textContent = `${message.replyTo.sender}: ${message.replyTo.content}`;
                div.appendChild(replyDiv);
            }

            const messageContent = document.createElement('div');
            messageContent.className = 'flex justify-between items-start';

            const leftPart = document.createElement('div');
            leftPart.className = 'flex-grow';

            const senderSpan = document.createElement('span');
            senderSpan.className = 'font-bold';
            senderSpan.textContent = message.sender + ': ';

            const contentSpan = document.createElement('span');
            contentSpan.textContent = message.content;

            leftPart.appendChild(senderSpan);
            leftPart.appendChild(contentSpan);

            const rightPart = document.createElement('div');
            rightPart.className = 'flex items-center';

            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs text-gray-500 mr-2';
            timeSpan.textContent = formatTimestamp(message.timestamp);

            const replyBtn = document.createElement('button');
            replyBtn.textContent = 'Reply';
            replyBtn.className = 'bg-gray-200 text-xs p-1 rounded mr-2';
            replyBtn.addEventListener('click', () => showDmReplyOption(messageId, message));

            rightPart.appendChild(timeSpan);
            rightPart.appendChild(replyBtn);

            if (message.sender === currentUser.email.split('@')[0]) {
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'bg-red-200 text-xs p-1 rounded';
                deleteBtn.addEventListener('click', () => deleteDmMessage(messageId));
                rightPart.appendChild(deleteBtn);
            }

            messageContent.appendChild(leftPart);
            messageContent.appendChild(rightPart);

            div.appendChild(messageContent);

            return div;
        }

        // Show DM reply option
        function showDmReplyOption(messageId, message) {
            dmReplyingTo = { id: messageId, sender: message.sender, content: message.content };
            dmReplyPreview.textContent = `Replying to ${message.sender}: ${message.content}`;
            dmReplyPreview.classList.remove('hidden');
            dmInput.focus();
        }

        // Send direct message
        function sendDirectMessage() {
            const content = dmInput.value.trim();
            if (content && currentDmUser) {
                const chatId = [currentUser.email.split('@')[0], currentDmUser].sort().join('_');
                const message = {
                    sender: currentUser.email.split('@')[0],
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    replyTo: dmReplyingTo
                };

                db.collection('directMessages').doc(chatId).collection('messages').add(message)
                    .then(() => {
                        dmInput.value = '';
                        dmReplyingTo = null;
                        dmReplyPreview.textContent = '';
                        dmReplyPreview.classList.add('hidden');
                    })
                    .catch((error) => {
                        console.error('Error sending direct message:', error);
                    });
            }
        }

        // Delete DM message
        function deleteDmMessage(messageId) {
            const chatId = [currentUser.email.split('@')[0], currentDmUser].sort().join('_');
            db.collection('directMessages').doc(chatId).collection('messages').doc(messageId).delete()
                .then(() => {
                    console.log('DM message deleted successfully');
                })
                .catch((error) => {
                    console.error('Error deleting DM message:', error);
                });
        }

        // Open DMs window
        function openDmsWindow() {
            dmContainer.classList.remove('hidden');
            chatContainer.classList.add('hidden');
            dmHeader.textContent = 'Your Direct Messages';
            loadUserDms();
        }

        // Load user's DMs
        function loadUserDms() {
            const currentUsername = currentUser.email.split('@')[0];
            db.collection('directMessages').where('participants', 'array-contains', currentUsername).get()
                .then((querySnapshot) => {
                    dmMessagesDiv.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const chatData = doc.data();
                        const otherUser = chatData.participants.find(user => user !== currentUsername);
                        const dmButton = createDmButton(otherUser);
                        dmMessagesDiv.appendChild(dmButton);
                    });
                })
                .catch((error) => {
                    console.error('Error loading DMs:', error);
                });
        }

        // Create DM button
        function createDmButton(otherUser) {
            const button = document.createElement('button');
            button.className = 'bg-blue-500 text-white p-2 rounded mb-2 w-full text-left';
            button.textContent = `Chat with ${otherUser}`;
            button.addEventListener('click', () => openDmWindow(otherUser));
            return button;
        }

        // Function to open DM window
        function openDmWindow(otherUser) {
            currentDmUser = otherUser;
            chatContainer.classList.add('hidden');
            dmContainer.classList.remove('hidden');
            dmHeader.textContent = `Direct Message with ${otherUser}`;
            loadDirectMessages(otherUser);

            // Ensure the chat exists in Firestore
            const chatId = [currentUser.email.split('@')[0], otherUser].sort().join('_');
            db.collection('directMessages').doc(chatId).set({
                participants: [currentUser.email.split('@')[0], otherUser]
            }, { merge: true });
        }

        // Function to handle user logout
        function logout() {
            auth.signOut().then(() => {
                localStorage.removeItem('username');
                localStorage.removeItem('password');
                currentUser = null;
                loginContainer.classList.remove('hidden');
                chatContainer.classList.add('hidden');
                dmContainer.classList.add('hidden');
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        }

        // Event listeners
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            if (username && password) {
                login(username, password);
            }
        });

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        dmSendBtn.addEventListener('click', sendDirectMessage);
        dmInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendDirectMessage();
            }
        });

        backToChatBtn.addEventListener('click', () => {
            dmContainer.classList.add('hidden');
            chatContainer.classList.remove('hidden');
            currentDmUser = null;
        });

        openDmsBtn.addEventListener('click', openDmsWindow);

        // Add logout button
        const logoutBtn = document.createElement('button');
        logoutBtn.textContent = 'Logout';
        logoutBtn.className = 'bg-red-500 text-white p-2 rounded absolute top-4 right-4';
        logoutBtn.addEventListener('click', logout);
        document.body.appendChild(logoutBtn);

        // Initialize the chat application
        function initChat() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loginContainer.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    loadMessages();
                } else {
                    loginContainer.classList.remove('hidden');
                    chatContainer.classList.add('hidden');
                    dmContainer.classList.add('hidden');
                }
            });
        }

        // Call initChat to start the application
        initChat();
    </script>
</body>
</html>
